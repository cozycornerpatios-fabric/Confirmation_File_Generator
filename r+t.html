<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cushion Order Generator</title>
  <style>
    .cushion-section { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .field-group { margin-bottom: 5px; }
  </style>
  <script>
    function addCushion() {
      const container = document.getElementById('cushions');
      const index = container.children.length;
      const section = document.createElement('div');
      section.className = 'cushion-section';
      section.innerHTML = `
        <h3>Cushion ${index + 1}</h3>
        <div class="field-group">
          <label>Cushion Name: <input type="text" name="cushion_name_${index}" placeholder="e.g. Seat Cushion - 20x16" required></label>
        </div>
        <div class="field-group">
          <label>Shape: 
            <select name="shape_${index}" onchange="toggleFields(${index})">
              <option value="rectangle">Rectangle</option>
              <option value="trapezoid">Trapezoid</option>
            </select>
          </label>
        </div>
        <!-- Rectangle fields -->
        <div id="rect_fields_${index}">
          <div class="field-group"><label>Length (in): <input type="number" step="any" name="length_${index}"></label></div>
          <div class="field-group"><label>Width (in): <input type="number" step="any" name="width_${index}"></label></div>
          <div class="field-group"><label>Thickness (in): <input type="number" step="any" name="thickness_rect_${index}"></label></div>
          <div class="field-group"><label>Fill: <input type="text" name="fill_${index}"></label></div>
          <div class="field-group"><label>Fabric: <input type="text" name="fabric_${index}"></label></div>
          <div class="field-group"><label>Zipper Position: 
            <select name="zipper_rect_${index}"><option>Long Side</option><option>Short Side</option></select>
          </label></div>
          <div class="field-group"><label>Piping: 
            <select name="piping_rect_${index}"><option>Yes</option><option>No</option></select>
          </label></div>
          <div class="field-group"><label>Ties: <input type="text" name="ties_rect_${index}" placeholder="e.g. 4 Side Short"></label></div>
          <div class="field-group"><label>Quantity: <input type="number" name="quantity_${index}" value="1" min="1"></label></div>
        </div>
        <!-- Trapezoid fields -->
        <div id="trap_fields_${index}" style="display:none;">
          <div class="field-group"><label>Top Base (in): <input type="number" step="any" name="top_base_${index}"></label></div>
          <div class="field-group"><label>Bottom Base (in): <input type="number" step="any" name="bottom_base_${index}"></label></div>
          <div class="field-group"><label>Height (in): <input type="number" step="any" name="height_${index}"></label></div>
          <div class="field-group"><label>Thickness (in): <input type="number" step="any" name="thickness_trap_${index}"></label></div>
          <div class="field-group"><label>Zipper Position: 
            <select name="zipper_trap_${index}"><option>Top</option><option>Bottom</option><option>Left</option><option>Right</option></select>
          </label></div>
          <div class="field-group"><label>Piping: 
            <select name="piping_trap_${index}"><option>Yes</option><option>No</option></select>
          </label></div>
          <div class="field-group"><label>Ties: <input type="text" name="ties_trap_${index}" placeholder="e.g. 2 Back Ties"></label></div>
          <div class="field-group"><label>Product Details (comma-separated): <input type="text" name="product_details_${index}"></label></div>
        </div>
      `;
      container.appendChild(section);
    }

    function toggleFields(idx) {
      const shape = document.querySelector(`select[name=shape_${idx}]`).value;
      document.getElementById(`rect_fields_${idx}`).style.display = shape === 'rectangle' ? 'block' : 'none';
      document.getElementById(`trap_fields_${idx}`).style.display = shape === 'trapezoid' ? 'block' : 'none';
    }

    async function submitForm() {
      const form = document.getElementById('orderForm');
      const payload = {
        customer_name: form.customer_name.value,
        order_id: form.order_id.value || form.order_number.value,
        email: form.email.value,
        shipping_address: form.shipping_address.value.split(',').map(s=>s.trim()),
        billing_address: form.billing_address.value.split(',').map(s=>s.trim()),
        location: form.location.value,
        delivery_method: form.delivery_method.value,
        cushions: []
      };
      const count = document.getElementById('cushions').children.length;
      for (let i = 0; i < count; i++) {
        const shape = form[`shape_${i}`].value;
        const obj = { cushion_name: form[`cushion_name_${i}`].value };
        if (shape === 'rectangle') {
          Object.assign(obj, {
            length: parseFloat(form[`length_${i}`].value),
            width: parseFloat(form[`width_${i}`].value),
            thickness: parseFloat(form[`thickness_rect_${i}`].value),
            fill: form[`fill_${i}`].value,
            fabric: form[`fabric_${i}`].value,
            zipper: form[`zipper_rect_${i}`].value,
            piping: form[`piping_rect_${i}`].value,
            ties: form[`ties_rect_${i}`].value,
            quantity: parseInt(form[`quantity_${i}`].value,10)
          });
        } else {
          Object.assign(obj, {
            top_base: parseFloat(form[`top_base_${i}`].value),
            bottom_base: parseFloat(form[`bottom_base_${i}`].value),
            height: parseFloat(form[`height_${i}`].value),
            thickness: parseFloat(form[`thickness_trap_${i}`].value),
            zipper: form[`zipper_trap_${i}`].value,
            piping: form[`piping_trap_${i}`].value,
            ties: form[`ties_trap_${i}`].value,
            product_details: form[`product_details_${i}`].value.split(',').map(s=>s.trim())
          });
        }
        payload.cushions.push(obj);
      }
      try {
        const res = await fetch('/generate-cushions', {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.pdf_link) window.open(data.pdf_link, '_blank');
        else alert('Error: '+JSON.stringify(data));
      } catch(e) { alert('Request failed: '+e); }
    }

    window.onload = () => { addCushion(); };
  </script>
</head>
<body>
  <h1>Cushion Order Generator</h1>
  <form id="orderForm" onsubmit="event.preventDefault(); submitForm();">
    <div class="field-group"><label>Customer Name: <input type="text" name="customer_name" required></label></div>
    <div class="field-group"><label>Order Number/ID: <input type="text" name="order_id" required></label></div>
    <div class="field-group"><label>Email: <input type="email" name="email" required></label></div>
    <div class="field-group"><label>Shipping Address (comma-separated): <input type="text" name="shipping_address" required></label></div>
    <div class="field-group"><label>Billing Address (comma-separated): <input type="text" name="billing_address" required></label></div>
    <div class="field-group"><label>Location: <input type="text" name="location"></label></div>
    <div class="field-group"><label>Delivery Method: <input type="text" name="delivery_method"></label></div>
    <h2>Cushions</h2>
    <div id="cushions"></div>
    <button type="button" onclick="addCushion()">Add Cushion</button><br><br>
    <button type="submit">Generate PDF</button>
  </form>
</body>
</html>
